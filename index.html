<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connact Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .logo-container img {
            max-width: 200px;
            height: auto;
        }

        .tile, .drop-zone {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #000;
            box-sizing: border-box;
            border-radius: 8px;
            background-color: #fff;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .tile:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tile.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            cursor: default;
            transition: all 0.3s ease;
            text-align: center;
            border-style: solid;
        }

        .drop-zone.drag-over {
            background-color: #e8f5e8;
            border-color: #4CAF50;
            border-style: dashed;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .drop-zone:not(.drag-over):hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }

        .tile img, .drop-zone img {
            width: 92px;
            height: 92px;
            object-fit: cover;
            border-radius: 4px;
        }

        .clear-button {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #666;
        }

        .clear-button:hover {
            background: rgba(255, 255, 255, 1);
            color: #333;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sequence-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 3px;
            justify-content: center;
            margin-bottom: 15px;
            width: 200px;
            height: 200px;
            margin: 0 auto 15px auto;
        }

        .final-jason-tile {
            display: none; /* Not needed in rectangular layout */
        }

        .png-grid {
            display: grid;
            grid-template-columns: repeat(5, 50px);
            grid-template-rows: repeat(3, 50px);
            gap: 5px;
            max-width: 100%;
            margin-top: 10px;
            justify-content: center;
        }

        .png-tile {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #ccc;
            box-sizing: border-box;
            border-radius: 4px;
            background-color: #fff;
            cursor: grab;
            transition: transform 0.2s, opacity 0.2s, border-color 0.2s;
            touch-action: none; /* Prevent scrolling when dragging */
            user-select: none; /* Prevent text selection */
        }

        .png-tile:hover, .png-tile:active {
            transform: scale(1.05);
            border-color: #007bff;
        }

        .png-tile.dragging {
            opacity: 0.3;
            border-color: #28a745;
            transform: scale(0.95);
        }

        .png-tile:active {
            cursor: grabbing;
        }

        .png-tile img {
            width: 46px;
            height: 46px;
            object-fit: cover;
            border-radius: 2px;
        }

        .enter-button {
            display: none;
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
            animation: pulse 1.5s infinite;
        }

        .enter-button:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.4);
        }

        @keyframes pulse {
            0% { box-shadow: 0 2px 8px rgba(0,123,255,0.3); }
            50% { box-shadow: 0 4px 16px rgba(0,123,255,0.6); }
            100% { box-shadow: 0 2px 8px rgba(0,123,255,0.3); }
        }

        .game-info {
            text-align: center;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .game-instructions {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
            font-weight: normal;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.4;
        }

        .message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 10px auto;
            max-width: 600px;
            text-align: center;
        }

        .win-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 800px;
            text-align: center;
        }

        .sms-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .sms-button:hover {
            background: #218838;
        }

        /* Mobile Adjustments */
        @media screen and (max-width: 360px) {
            .tile, .drop-zone {
                width: 50px;
                height: 50px;
            }

            .tile img, .drop-zone img {
                width: 46px;
                height: 46px;
            }

            .sequence-grid {
                grid-template-columns: repeat(4, 50px);
                gap: 2px;
            }

            .final-jason-tile {
                width: 50px;
                height: 50px;
                left: -55px; /* 50px width + 5px gap to the left of grid */
                top: 156px; /* Row 4 position: (3 rows * 50px) + (3 gaps * 2px) = 156px */
            }

            .final-jason-tile img {
                width: 46px;
                height: 46px;
            }

            .png-grid {
                grid-template-columns: repeat(3, 25px);
                grid-template-rows: repeat(5, 25px);
                gap: 2px;
                max-width: 77px;
            }

            .png-tile {
                width: 25px;
                height: 25px;
            }

            .png-tile img {
                width: 23px;
                height: 23px;
            }

            .enter-button {
                padding: 5px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img id="gameLogo" src="connact_logo.png" alt="Game Logo" onerror="this.style.display='none';">
    </div>

    <div class="game-info">
        <div class="game-instructions">Connect actors through movies using just the images below to get back to our starting actor</div>
        <div id="attemptCounter">Attempt 1 of 7</div>
        <div id="gameMessage" class="message" style="display: none;"></div>
        <div id="winMessage" class="win-message" style="display: none;"></div>
    </div>

    <div class="game-container">
        <div class="sequence-grid" id="sequenceGrid"></div>
        <button id="enterButton" class="enter-button" onclick="submitMove()" style="display: none;">Enter</button>
        <div class="png-grid" id="pngGrid"></div>
    </div>

    <script>
        // Game Configuration
        var gameConfig = {
            anchor: {
                name: "Jason Bateman",
                file: "actors/jason_bateman.png"
            },
            sequence: [
                {name: "Identity Thief", file: "movies/identitythief.png", type: "movie"},
                {name: "Melissa McCarthy", file: "actors/Melissa_McCarthy.png", type: "actor"},
                {name: "Bridesmaids", file: "movies/bridesmaids.png", type: "movie"},
                {name: "Rebel Wilson", file: "actors/rebel_wilson.png", type: "actor"},
                {name: "Pitch Perfect", file: "movies/pitchperfect.png", type: "movie"},
                {name: "Anna Kendrick", file: "actors/anna_kendrick.png", type: "actor"},
                {name: "Up in the Air", file: "movies/upintheair.png", type: "movie"},
                {name: "Vera Farmiga", file: "actors/vera_farmiga.png", type: "actor"},
                {name: "The Departed", file: "movies/thedeparted.png", type: "movie"},
                {name: "Mark Wahlberg", file: "actors/mark_wahlberg.png", type: "actor"},
                {name: "Ted", file: "movies/ted.png", type: "movie"},
                {name: "Mila Kunis", file: "actors/mila_kunis.png", type: "actor"},
                {name: "Bad Moms", file: "movies/badmoms.png", type: "movie"},
                {name: "Kristen Bell", file: "actors/kristen_bell.png", type: "actor"},
                {name: "Couples Retreat", file: "movies/couplesretreat.png", type: "movie"}
            ],
            smsNumber: "+61459754708",
            logoFile: "connact_logo.png"
        };

        // Variables
        var currentAttempt = 1;
        var maxAttempts = 7;
        var gameWon = false;
        var revealInProgress = false;
        var correctAnswers = {};
        var placedImages = new Map();
        var sequencePositions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]; // Rectangular circuit
        var rectangularLayout = [
            [1,  2,  3,  4 ],  // Top row
            [16, 0,  0,  5 ],  // Middle rows (0 = empty)
            [15, 0,  0,  6 ],  
            [14, 13, 12, 11]   // Bottom row: ... ‚Üê 11 ‚Üê 10 ‚Üê 9 ‚Üê 8 ‚Üê 7
        ];
        var validPaths = {
            clockwise: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16], // Jason ‚Üí Identity ‚Üí ...
            counterclockwise: [16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2] // Jason ‚Üí Couples ‚Üí ...
        };
        var currentPosition = 2;
        var draggedTile = null;
        var pngTiles = [];
        var finalJasonAdded = false; // Track if final Jason has been added
        
        // Touch support variables
        var touchedTile = null;
        var isDragging = false;
        var isMobile = false;

        // Initialize game
        function initializeGame() {
            currentPosition = 1; // Start at Jason position
            gameWon = false;
            revealInProgress = false;
            placedImages.clear();
            draggedTile = null;
            finalJasonAdded = false;
            
            // Reset path tracking
            playerPath = [];
            pathDirection = null;
            
            generateCorrectAnswers();
            createInitialSequence();
            createPngGrid();
            attachEventListeners();
            console.log('Rectangular circuit game initialized');
        }

        function generateCorrectAnswers() {
            correctAnswers = {};
            
            // Position 1 is always Jason (anchor)
            // Positions 2 and 16 are the two starting options from Jason
            correctAnswers['dropTile2'] = gameConfig.sequence[0].file; // Identity Thief (clockwise)
            correctAnswers['dropTile16'] = gameConfig.sequence[14].file; // Couples Retreat (counterclockwise)
            
            // Generate answers for both directions
            for (var i = 1; i < gameConfig.sequence.length - 1; i++) {
                // Clockwise path: positions 3, 4, 5, etc.
                correctAnswers['dropTile' + (i + 2)] = gameConfig.sequence[i].file;
                
                // Counterclockwise path: positions 15, 14, 13, etc.
                correctAnswers['dropTile' + (16 - i)] = gameConfig.sequence[14 - i].file;
            }
            
            console.log('=== BIDIRECTIONAL ANSWERS MAPPING ===');
            console.log('Jason at position 1');
            console.log('Clockwise start - Position 2:', gameConfig.sequence[0].name);
            console.log('Counterclockwise start - Position 16:', gameConfig.sequence[14].name);
            for (var pos in correctAnswers) {
                console.log(pos + ':', correctAnswers[pos]);
            }
            console.log('=====================================');
        }

        function updateGridSize() {
            var sequenceGrid = document.getElementById('sequenceGrid');
            var allTiles = sequenceGrid.querySelectorAll('.tile:not(.final-jason-tile), .drop-zone');
            var maxRow = 1;
            
            // Find the highest row number currently in use (excluding Jason)
            for (var i = 0; i < allTiles.length; i++) {
                var gridArea = allTiles[i].style.gridArea;
                if (gridArea) {
                    var parts = gridArea.split(' / ');
                    var row = parseInt(parts[0]);
                    if (row > maxRow) {
                        maxRow = row;
                    }
                }
            }
            
            // Check if we're on mobile (screen width <= 360px)
            var isMobile = window.innerWidth <= 360;
            var tileSize = isMobile ? '50px' : '100px';
            
            // Update the grid to only have the rows we need
            sequenceGrid.style.gridTemplateRows = 'repeat(' + maxRow + ', ' + tileSize + ')';
            console.log('Grid updated to', maxRow, 'rows (' + tileSize + ' each) - Jason positioned outside');
        }

        function createInitialSequence() {
            var sequenceGrid = document.getElementById('sequenceGrid');
            sequenceGrid.innerHTML = '';

            // Create 4x4 grid (16 positions)
            for (var pos = 1; pos <= 16; pos++) {
                if (pos === 1) {
                    // Jason at position 1 (top-left corner)
                    var anchorTile = document.createElement('div');
                    anchorTile.className = 'tile';
                    anchorTile.style.gridArea = '1 / 1';
                    anchorTile.setAttribute('data-src', gameConfig.anchor.file);
                    anchorTile.setAttribute('data-name', gameConfig.anchor.name);

                    var img = document.createElement('img');
                    img.src = gameConfig.anchor.file;
                    img.alt = gameConfig.anchor.name;
                    img.onerror = function() {
                        anchorTile.innerHTML = '<div style="padding:2px; text-align:center; color:#999; font-size:6px;">' + gameConfig.anchor.name + '</div>';
                    };

                    anchorTile.appendChild(img);
                    sequenceGrid.appendChild(anchorTile);
                    
                } else if (pos === 2) {
                    // First starting option: Identity Thief (clockwise)
                    var dropZone = document.createElement('div');
                    dropZone.className = 'drop-zone';
                    dropZone.id = 'dropTile2';
                    dropZone.style.gridArea = '1 / 2';
                    dropZone.innerHTML = '<span style="color: #007bff; font-weight: bold;">Movie</span>';
                    sequenceGrid.appendChild(dropZone);
                    
                } else if (pos === 16) {
                    // Second starting option: Couples Retreat (counterclockwise)  
                    var dropZone = document.createElement('div');
                    dropZone.className = 'drop-zone';
                    dropZone.id = 'dropTile16';
                    dropZone.style.gridArea = '4 / 1';
                    dropZone.innerHTML = '<span style="color: #007bff; font-weight: bold;">Movie</span>';
                    sequenceGrid.appendChild(dropZone);
                }
            }

            // Update grid size
            updateGridSize();
            
            console.log('=== INITIAL RECTANGULAR SETUP ===');
            console.log('Jason at position 1');
            console.log('Starting options:');
            console.log('  Position 2 (clockwise):', gameConfig.sequence[0].name);
            console.log('  Position 16 (counterclockwise):', gameConfig.sequence[14].name);
            console.log('==================================');
        }

        function createPngGrid() {
            var pngGrid = document.getElementById('pngGrid');
            pngGrid.innerHTML = '';
            pngTiles = [];

            var allImages = gameConfig.sequence.slice();
            
            // Traditional array shuffle (Fisher-Yates)
            for (var i = allImages.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = allImages[i];
                allImages[i] = allImages[j];
                allImages[j] = temp;
            }

            console.log('=== PNG TILES CREATED ===');
            for (var i = 0; i < allImages.length; i++) {
                var item = allImages[i];
                var tile = document.createElement('div');
                tile.className = 'png-tile';
                tile.setAttribute('draggable', 'true');
                tile.setAttribute('data-src', item.file);
                tile.setAttribute('data-name', item.name);
                pngTiles.push(tile);

                console.log('PNG Tile:', item.name, '‚Üí', item.file);

                var img = document.createElement('img');
                img.src = item.file;
                img.alt = item.name;
                img.onerror = function() {
                    this.parentNode.innerHTML = '<div style="padding:5px; text-align:center; color:#999; font-size:8px;">' + this.alt + '</div>';
                };

                tile.appendChild(img);
                pngGrid.appendChild(tile);
            }
            console.log('========================');
            console.log('PNG grid created with', pngTiles.length, 'tiles');
        }

        function attachEventListeners() {
            var imageElements = document.querySelectorAll('.png-tile');
            
            // Detect if mobile
            isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;

            for (var i = 0; i < imageElements.length; i++) {
                if (isMobile) {
                    // Mobile: Simple tap to place
                    imageElements[i].addEventListener('touchstart', function(e) {
                        if (gameWon || revealInProgress) return;
                        e.preventDefault();
                        
                        var imageSrc = this.getAttribute('data-src');
                        var imageName = this.getAttribute('data-name');
                        
                        // Find next empty drop zone
                        var nextDropZone = findNextEmptyDropZone();
                        if (nextDropZone) {
                            draggedTile = this;
                            this.style.opacity = '0.3';
                            nextDropZone.style.backgroundColor = '#fff3cd';
                            nextDropZone.style.borderColor = '#ffc107';
                            nextDropZone.classList.add('drag-over');
                            
                            var enterButton = document.getElementById('enterButton');
                            enterButton.style.display = 'block';
                            enterButton.style.backgroundColor = '#28a745';
                            enterButton.textContent = 'Submit "' + imageName + '"';
                            
                            console.log('Mobile tap - ready to submit:', imageName, 'to', nextDropZone.id);
                        }
                    });
                } else {
                    // Desktop: Drag and drop
                    imageElements[i].addEventListener('dragstart', function(e) {
                        if (gameWon || revealInProgress) return;
                        
                        draggedTile = this;
                        var imgSrc = this.getAttribute('data-src');
                        var imgName = this.getAttribute('data-name');
                        e.dataTransfer.setData('text/plain', imgSrc);
                        e.dataTransfer.setData('text/name', imgName);
                        e.dataTransfer.effectAllowed = 'move';
                        this.classList.add('dragging');
                        console.log('Drag started on', imgName);
                    });

                    imageElements[i].addEventListener('dragend', function(e) {
                        this.classList.remove('dragging');
                        console.log('Drag ended');
                    });
                }
            }

            // Attach listeners to existing drop zones
            attachDropZoneListeners();
        }

        function findNextEmptyDropZone() {
            // Find the first empty drop zone based on current game state
            if (playerPath.length === 0) {
                // First move: player can choose either starting position
                var dropZone2 = document.getElementById('dropTile2');
                var dropZone16 = document.getElementById('dropTile16');
                
                if (dropZone2 && !dropZone2.querySelector('img')) {
                    return dropZone2;
                }
                if (dropZone16 && !dropZone16.querySelector('img')) {
                    return dropZone16;
                }
            } else {
                // Subsequent moves: find next in chosen path
                var dropZones = document.querySelectorAll('.drop-zone');
                for (var i = 0; i < dropZones.length; i++) {
                    if (!dropZones[i].querySelector('img')) {
                        return dropZones[i];
                    }
                }
            }
            return null;
        }

        function attachDropZoneListeners() {
            var dropZones = document.querySelectorAll('.drop-zone');
            
            for (var i = 0; i < dropZones.length; i++) {
                // Remove existing listeners by cloning the element
                var newDropZone = dropZones[i].cloneNode(true);
                dropZones[i].parentNode.replaceChild(newDropZone, dropZones[i]);
                
                // Add fresh event listeners
                newDropZone.addEventListener('dragover', function(e) {
                    if (gameWon || revealInProgress) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    // Remove drag-over from all other zones
                    var allZones = document.querySelectorAll('.drop-zone');
                    for (var j = 0; j < allZones.length; j++) {
                        allZones[j].classList.remove('drag-over');
                    }
                    
                    this.classList.add('drag-over');
                    document.getElementById('enterButton').style.display = 'block';
                    console.log('Drag over', this.id);
                });
                
                newDropZone.addEventListener('dragleave', function(e) {
                    // Only remove if we're actually leaving the drop zone area
                    var rect = this.getBoundingClientRect();
                    var x = e.clientX;
                    var y = e.clientY;
                    
                    if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                        this.classList.remove('drag-over');
                        // Check if any zones still have drag-over
                        if (!document.querySelector('.drop-zone.drag-over')) {
                            document.getElementById('enterButton').style.display = 'none';
                        }
                    }
                    console.log('Drag leave', this.id);
                });
                
                newDropZone.addEventListener('drop', function(e) {
                    if (gameWon || revealInProgress) return;
                    
                    e.preventDefault();
                    
                    var imageSrc = e.dataTransfer.getData('text/plain');
                    var imageName = e.dataTransfer.getData('text/name');
                    
                    if (imageSrc && !this.querySelector('img') && draggedTile) {
                        // Visual feedback that something is ready to be submitted
                        draggedTile.style.opacity = '0.3';
                        this.style.backgroundColor = '#fff3cd';
                        this.style.borderColor = '#ffc107';
                        
                        var enterButton = document.getElementById('enterButton');
                        enterButton.style.display = 'block';
                        enterButton.style.backgroundColor = '#28a745';
                        enterButton.textContent = 'Submit "' + imageName + '"';
                        
                        console.log('Ready to submit:', imageName, 'to', this.id);
                    }
                });
            }
        }

        function submitMove() {
            if (!draggedTile) {
                console.log('No dragged tile');
                return;
            }

            var dropZone = document.querySelector('.drop-zone.drag-over');
            if (!dropZone) {
                console.log('No drop zone with drag-over class');
                return;
            }

            var imageSrc = draggedTile.getAttribute('data-src');
            var imageName = draggedTile.getAttribute('data-name');
            var correctImage = correctAnswers[dropZone.id];

            console.log('=== SUBMIT MOVE DEBUG ===');
            console.log('Drop Zone:', dropZone.id);
            console.log('Player dragged:', imageName, '‚Üí', imageSrc);
            console.log('Expected:', correctImage);
            console.log('Match:', imageSrc === correctImage);
            console.log('========================');
            
            if (imageSrc === correctImage) {
                // Correct move
                placeImageInTile(dropZone, imageSrc, imageName);
                draggedTile.parentNode.removeChild(draggedTile);
                draggedTile = null;
                
                // Clear visual feedback
                dropZone.classList.remove('drag-over');
                dropZone.style.backgroundColor = '';
                dropZone.style.borderColor = '';
                document.getElementById('enterButton').style.display = 'none';
                document.getElementById('gameMessage').style.display = 'none';
                
                // Track path direction on first move
                if (playerPath.length === 0) {
                    if (dropZone.id === 'dropTile2') {
                        pathDirection = 'clockwise';
                        console.log('üîÑ Player chose CLOCKWISE path');
                    } else if (dropZone.id === 'dropTile16') {
                        pathDirection = 'counterclockwise';
                        console.log('üîÑ Player chose COUNTERCLOCKWISE path');
                    }
                }
                
                // Add to player path
                playerPath.push(dropZone.id);
                
                // Add next tile based on chosen direction
                addNextTileInPath();
                checkIfAllTilesFilled();
                console.log('‚úÖ CORRECT! Path direction:', pathDirection);
            } else {
                // Incorrect move
                dropZone.classList.remove('drag-over');
                dropZone.style.backgroundColor = '';
                dropZone.style.borderColor = '';
                draggedTile.style.opacity = '1';
                
                var remainingAttempts = maxAttempts - currentAttempt;
                document.getElementById('gameMessage').innerHTML = '‚ùå Wrong! You have ' + remainingAttempts + ' attempts remaining.';
                document.getElementById('gameMessage').style.display = 'block';
                document.getElementById('gameMessage').style.background = '#f8d7da';
                document.getElementById('gameMessage').style.borderColor = '#f5c6cb';
                document.getElementById('gameMessage').style.color = '#721c24';
                
                document.getElementById('enterButton').style.display = 'none';
                draggedTile = null;
                
                if (currentAttempt < maxAttempts) {
                    currentAttempt++;
                    document.getElementById('attemptCounter').textContent = 'Attempt ' + currentAttempt + ' of ' + maxAttempts;
                } else {
                    // Game over
                    document.getElementById('gameMessage').innerHTML = 'Game Over! You have used all ' + maxAttempts + ' attempts.';
                    gameWon = true; // Prevent further interactions
                }
                console.log('‚ùå INCORRECT! Attempt', currentAttempt);
            }
        }

        function addNextTileInPath() {
            if (!pathDirection || playerPath.length >= 15) return;
            
            var nextPosition;
            var sequenceIndex;
            
            if (pathDirection === 'clockwise') {
                nextPosition = playerPath.length + 2; // 2, 3, 4, 5, etc.
                sequenceIndex = playerPath.length; // 0, 1, 2, 3, etc.
                if (nextPosition > 16) return;
            } else {
                nextPosition = 16 - playerPath.length; // 16, 15, 14, 13, etc.
                sequenceIndex = 14 - playerPath.length; // 14, 13, 12, 11, etc.
                if (nextPosition < 1) return;
            }
            
            // Calculate grid position (1-16 to row/col in 4x4 grid)
            var row = Math.ceil(nextPosition / 4);
            var col = ((nextPosition - 1) % 4) + 1;
            
            var sequenceGrid = document.getElementById('sequenceGrid');
            var newDropZone = document.createElement('div');
            newDropZone.className = 'drop-zone';
            newDropZone.id = 'dropTile' + nextPosition;
            newDropZone.style.gridArea = row + ' / ' + col;
            
            // Determine if it's movie or actor based on sequence
            var expectedItem = gameConfig.sequence[sequenceIndex];
            var isMovieTile = expectedItem.type === 'movie';
            var color = isMovieTile ? '#007bff' : '#28a745';
            var label = isMovieTile ? 'Movie' : 'Actor';
            
            newDropZone.innerHTML = '<span style="color: ' + color + '; font-weight: bold;">' + label + '</span>';
            sequenceGrid.appendChild(newDropZone);
            
            // Reattach listeners
            attachDropZoneListeners();
            
            console.log('=== ADDED NEXT TILE ===');
            console.log('Direction:', pathDirection);
            console.log('Position:', nextPosition, '(Row ' + row + ', Col ' + col + ')');
            console.log('Expected:', expectedItem.name, '(' + expectedItem.type + ')');
            console.log('======================');
        }

        function placeImageInTile(dropZone, imageSrc, imageName) {
            // Preserve the grid positioning
            var gridArea = dropZone.style.gridArea;
            
            dropZone.innerHTML = '';
            
            // Restore grid positioning  
            dropZone.style.gridArea = gridArea;
            
            placedImages.set(dropZone.id, {src: imageSrc, name: imageName});
            
            var img = document.createElement('img');
            img.src = imageSrc;
            img.alt = imageName;
            img.style.width = '92px';
            img.style.height = '92px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            
            img.onerror = function() {
                dropZone.innerHTML = '<div style="padding:10px; color:#999; font-size:10px;">' + imageName + '<br><small>(Image not found)</small></div>';
                dropZone.style.gridArea = gridArea; // Restore grid positioning even on error
            };
            
            var clearButton = document.createElement('div');
            clearButton.className = 'clear-button';
            clearButton.innerHTML = '√ó';
            clearButton.title = 'Clear image';
            clearButton.addEventListener('click', function() { 
                clearTile(dropZone); 
            });
            
            dropZone.appendChild(img);
            dropZone.appendChild(clearButton);
            console.log('Image placed in', dropZone.id, 'at grid position', gridArea);
        }

        function clearTile(tile) {
            var tileNumber = tile.id.replace('dropTile', '');
            var tileNum = parseInt(tileNumber);
            
            // Preserve grid positioning
            var gridArea = tile.style.gridArea;
            
            var placedImage = placedImages.get(tile.id);
            
            var isMovieTile = tileNum % 2 === 0;
            var color = isMovieTile ? '#007bff' : '#28a745';
            var label = isMovieTile ? 'Movie' : 'Actor';
            
            tile.innerHTML = '<span style="color: ' + color + '; font-weight: bold; font-size: 12px;">' + label + '</span>';
            tile.style.backgroundColor = '';
            tile.style.borderColor = '';
            
            // Restore grid positioning
            tile.style.gridArea = gridArea;
            
            placedImages.delete(tile.id);
            
            // Reattach listeners after clearing
            attachDropZoneListeners();
            
            checkIfAllTilesFilled();
            console.log('Tile cleared', tile.id, 'at grid position', gridArea);
        }

        function addNextTile() {
            currentPosition++;
            if (currentPosition > 16) return;

            var sequenceGrid = document.getElementById('sequenceGrid');
            var newDropZone = document.createElement('div');
            newDropZone.className = 'drop-zone';
            
            var gridPosition = sequencePositions[currentPosition - 1];
            newDropZone.id = 'dropTile' + gridPosition;
            
            // Convert position to grid coordinates (1-16 to row/col) - NO SHIFTING
            var row = Math.ceil(gridPosition / 4);
            var col = ((gridPosition - 1) % 4) + 1;
            
            newDropZone.style.gridArea = row + ' / ' + col;

            // Determine tile type based on sequence index, not position number
            var sequenceIndex = currentPosition - 2; // -2 because position 1 is anchor, position 2 is first sequence item
            var isMovieTile = sequenceIndex % 2 === 0; // Even sequence indices are movies, odd are actors
            var color = isMovieTile ? '#007bff' : '#28a745';
            var label = isMovieTile ? 'Movie' : 'Actor';

            newDropZone.innerHTML = '<span style="color: ' + color + '; font-weight: bold; font-size: 12px;">' + label + '</span>';
            sequenceGrid.appendChild(newDropZone);

            // Check if this tile is in the final row (row 4) AND it's an actor tile AND we haven't added Jason yet
            var isInFinalRow = row === 4;
            var isActorTile = !isMovieTile;
            
            if (isInFinalRow && isActorTile && !finalJasonAdded) {
                // Add final Jason Bateman tile OUTSIDE the grid
                addFinalJasonBateman();
                finalJasonAdded = true;
                console.log('üéØ First actor in final row - Added Jason Bateman completion target OUTSIDE the grid!');
            }

            // Update grid size to accommodate new tile
            updateGridSize();

            // Reattach all drop zone listeners to include the new one
            attachDropZoneListeners();

            var expectedItem = gameConfig.sequence[sequenceIndex];
            console.log('=== ADDED NEW TILE ===');
            console.log('Current position:', currentPosition);
            console.log('Grid position:', gridPosition, '(Row ' + row + ', Col ' + col + ')');
            console.log('Sequence index:', sequenceIndex);
            console.log('Expected:', expectedItem ? expectedItem.name : 'unknown', '(' + label.toLowerCase() + ')');
            console.log('Expected file:', expectedItem ? expectedItem.file : 'unknown');
            console.log('======================');
        }

        function addFinalJasonBateman() {
            var sequenceGrid = document.getElementById('sequenceGrid');
            
            // Create Jason as an absolutely positioned element OUTSIDE the grid
            var finalTile = document.createElement('div');
            finalTile.className = 'tile final-jason-tile';
            finalTile.id = 'finalJasonTile';
            finalTile.setAttribute('data-src', gameConfig.anchor.file);
            finalTile.setAttribute('data-name', gameConfig.anchor.name + ' (Circuit Complete)');

            var img = document.createElement('img');
            img.src = gameConfig.anchor.file;
            img.alt = gameConfig.anchor.name;
            img.onerror = function() {
                finalTile.innerHTML = '<div style="padding:10px; text-align:center; color:#999; font-size:10px;">' + gameConfig.anchor.name + '<br><small>(Circuit Complete)</small></div>';
            };

            finalTile.appendChild(img);
            
            // Add a small indicator that this completes the circuit
            var circuitLabel = document.createElement('div');
            circuitLabel.style.position = 'absolute';
            circuitLabel.style.bottom = '2px';
            circuitLabel.style.left = '2px';
            circuitLabel.style.background = 'rgba(40, 167, 69, 0.9)';
            circuitLabel.style.color = 'white';
            circuitLabel.style.fontSize = '8px';
            circuitLabel.style.padding = '1px 3px';
            circuitLabel.style.borderRadius = '3px';
            circuitLabel.textContent = 'COMPLETE';
            finalTile.appendChild(circuitLabel);
            
            // Add Jason to the sequence grid container (but positioned absolutely outside)
            sequenceGrid.appendChild(finalTile);
            
            console.log('Added final Jason Bateman tile as absolutely positioned element outside the grid');
        }

        function checkIfAllTilesFilled() {
            var totalTiles = Object.keys(correctAnswers).length;
            var filledTiles = placedImages.size;
            
            if (filledTiles === totalTiles) {
                gameWon = true;
                showWinMessage();
            }
            console.log('Checked tiles:', filledTiles, '/', totalTiles);
        }

        function showWinMessage() {
            var sequenceNames = [];
            for (var i = 0; i < gameConfig.sequence.length; i++) {
                sequenceNames.push(gameConfig.sequence[i].name);
            }
            var progression = gameConfig.anchor.name + ' ‚Üí ' + sequenceNames.join(' ‚Üí ');
            var winMessage = document.getElementById('winMessage');
            var gameMessage = document.getElementById('gameMessage');
            
            gameMessage.style.display = 'none';
            
            winMessage.innerHTML = '<h2>üéâ Congratulations! üéâ</h2><p><strong>Movie Sequence ' + currentAttempt + '/7</strong></p><p>' + progression + '</p><button class="sms-button" onclick="sendSMS()">Share Results</button>';
            winMessage.style.display = 'block';
            
            document.getElementById('attemptCounter').textContent = 'Completed in ' + currentAttempt + (currentAttempt === 1 ? ' attempt!' : ' attempts!');
            console.log('Win message shown');
        }
        
        function sendSMS() {
            var sequenceNames = [];
            for (var i = 0; i < gameConfig.sequence.length; i++) {
                sequenceNames.push(gameConfig.sequence[i].name);
            }
            var progression = gameConfig.anchor.name + ' ‚Üí ' + sequenceNames.join(' ‚Üí ');
            var attemptsText = currentAttempt === 1 ? "1 attempt" : currentAttempt + " attempts";
            var message = 'Movie Sequence ' + currentAttempt + '/7\n\n' + progression + '\n\nCompleted in ' + attemptsText + '!';
            
            var smsURL = 'sms:' + gameConfig.smsNumber + '?body=' + encodeURIComponent(message);
            window.open(smsURL, '_blank');
            console.log('SMS sent');
        }

                
        function resetDragState() {
            // Clear all drag states
            var draggingTiles = document.querySelectorAll('.png-tile.dragging');
            for (var i = 0; i < draggingTiles.length; i++) {
                draggingTiles[i].classList.remove('dragging');
                draggingTiles[i].style.opacity = '1';
            }
            
            var dragOverZones = document.querySelectorAll('.drop-zone.drag-over');
            for (var i = 0; i < dragOverZones.length; i++) {
                dragOverZones[i].classList.remove('drag-over');
                dragOverZones[i].style.backgroundColor = '';
                dragOverZones[i].style.borderColor = '';
            }
            
            var enterButton = document.getElementById('enterButton');
            enterButton.style.display = 'none';
            enterButton.textContent = 'Enter';
            enterButton.style.backgroundColor = '#007bff';
            
            // Reset both drag and touch states
            draggedTile = null;
            touchedTile = null;
            isDragging = false;
            
            console.log('Drag state reset');
        }

        // Add this to the window to handle any drag interruptions
        window.addEventListener('dragend', function(e) {
            if (e.target.classList.contains('png-tile')) {
                setTimeout(function() {
                    if (!document.querySelector('.drop-zone.drag-over')) {
                        resetDragState();
                    }
                }, 100);
            }
        });

        // Handle window resize to update grid size
        window.addEventListener('resize', function() {
            updateGridSize();
        });

        // Initialize everything
        window.addEventListener('load', function() {
            try {
                initializeGame();
                
                console.log('Game initialized successfully');
            } catch (error) {
                console.error('Error initializing game:', error);
            }
        });
    </script>
</body>
</html>